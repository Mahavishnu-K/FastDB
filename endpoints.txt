import axios from 'axios';

const API_URL = 'http://localhost:8000/api';

const apiClient = axios.create({
  baseURL: API_URL,
});

export const initializeApiClient = (token) => {
  // Use an interceptor to dynamically add the latest token to every request.
  // This is better than setting a default header, as the token might be refreshed.
  apiClient.interceptors.request.use(
    (config) => {
      // The token can be either a JWT from login or an API key from .env for testing.
      if (token) {
        config.headers['Authorization'] = `Bearer ${token}`;
      }
      return config;
    },
    (error) => Promise.reject(error)
  );
};

const authApiClient = axios.create({ baseURL: 'http://localhost:8000' });

export const loginUser = async (email, password) => {
    const response = await authApiClient.post('/auth/login', { email, password });
    return response.data; // returns { access_token, token_type }
};

export const signupUser = async (name, email, password) => {
    const response = await authApiClient.post('/auth/signup', { name, email, password });
    return response.data;
};

// ---- Database & Schema Endpoints ----

export const listDatabases = async () => {
  const response = await apiClient.get('/databases/');
  return response.data;
};

export const getDatabaseSchema = async (dbName) => {
  const response = await apiClient.get('/schema/', {
    headers: { 'X-Target-Database': dbName } 
  });
  return response.data;
};

export const deleteTable = async (tableName, dbName) => {
  const response = await apiClient.delete(`/schema/table/${tableName}`, {
    headers: { 'X-Target-Database': dbName }
  });
  return response.data;
};

export const exportSchemaSQL = async (dbName) => {
    const response = await apiClient.get('/schema/export', {
      headers: { 'X-Target-Database': dbName }
    });
    return response.data;
};

export const getMermaidDiagram = async (dbName) => {
  const response = await apiClient.get('/schema/mermaid', {
    headers: { 'X-Target-Database': dbName }
  });
  return response.data;
};

// ---- NLP & Query Execution Endpoints ----

export const convertNlToSql = async (command, dbName) => {
  const response = await apiClient.post('/query/nl', { command }, {
    headers: { 'X-Target-Database': dbName }
  });
  return response.data;
};

export const executeCommand = async (command, dbName) => {
  const response = await apiClient.post('/query/', { command }, {
    headers: { 'X-Target-Database': dbName }
  });
  return response.data;
};

// ---- Data Endpoints ----

export const getTableData = async (tableName, dbName) => {
    const response = await apiClient.get(`/data/table/${tableName}`, {
      headers: { 'X-Target-Database': dbName }
    });
    return response.data;
};

// ---- History Endpoints ----
// These do not need the X-Target-Database header, but will still get the Auth header.

export const getQueryHistory = async () => {
    const response = await apiClient.get('/history/');
    return response.data;
}

export const getSavedQueries = async () => {
    const response = await apiClient.get('/history/saved-queries');
    return response.data;
}

export const saveQuery = async (name, query) => {
    const response = await apiClient.post('/history/saved-queries', { name, query });
    return response.data;
}

//Collab Endpoints

/**
 * Fetches databases that the current user owns AND has shared with others.
 * @returns {Promise<Array<object>>} A list of the user's shared database objects.
 */
export const listDbsSharedByMe = async () => {
  const response = await apiClient.get('/databases/shared-by-me');
  return response.data;
};

/**
 * Fetches databases that have been shared WITH the current user.
 * @returns {Promise<Array<object>>} A list of collaborated database objects.
 */
export const listDbsSharedWithMe = async () => {
  const response = await apiClient.get('/databases/collaborations');
  return response.data;
};

/**
 * Fetches the list of all members (owner + collaborators) for a specific database.
 * @param {string} dbName The virtual name of the database.
 * @returns {Promise<Array<object>>} A list of member objects, each with user_id, name, email, and role.
 */
export const getDatabaseMembers = async (dbName) => {
  const response = await apiClient.get(`/databases/${dbName}/members`);
  return response.data;
};

/**
 * Invites a new user to collaborate on a database.
 * @param {string} dbName The virtual name of the database.
 * @param {string} email The email of the user to invite.
 * @param {string} role The role to assign (e.g., 'editor', 'viewer').
 * @returns {Promise<object>} The new member object.
 */
export const inviteUserToDb = async (dbName, email, role) => {
  const response = await apiClient.post(`/databases/${dbName}/members`, { email, role });
  return response.data;
};

/**
 * Updates the role of an existing collaborator.
 * @param {string} dbName The virtual name of the database.
 * @param {string} memberUserId The user ID of the member to update.
 * @param {string} role The new role to assign.
 * @returns {Promise<object>} The updated member object.
 */
export const updateMemberRole = async (dbName, memberUserId, role) => {
  const response = await apiClient.put(`/databases/${dbName}/members/${memberUserId}`, { role });
  return response.data;
};

/**
 * Removes a collaborator from a database (revokes access).
 * @param {string} dbName The virtual name of the database.
 * @param {string} memberUserId The user ID of the member to remove.
 * @returns {Promise<void>}
 */
export const removeMemberFromDb = async (dbName, memberUserId) => {
  // A DELETE request with a 204 response doesn't typically have a body to return.
  await apiClient.delete(`/databases/${dbName}/members/${memberUserId}`);
};
